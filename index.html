<script>
  // Variables globales para Three.js
  let scene, camera, renderer, mesh, animationId;
  const viewer = document.getElementById('viewer');
  const loadingMessage = viewer.querySelector('.loading');

  // Función mejorada para cargar STL
  function cargarSTL(file) {
    // Verificar que el archivo sea válido
    if (!file || !file.name.endsWith('.stl')) {
      loadingMessage.textContent = 'Archivo no válido. Debe ser un archivo .stl';
      loadingMessage.style.display = 'block';
      return;
    }

    loadingMessage.textContent = "Cargando modelo...";
    loadingMessage.style.display = 'block';

    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        initThreeJS(); // Reiniciar la escena
        
        const loader = new THREE.STLLoader();
        
        // Usar callback para manejar errores
        loader.load(
          URL.createObjectURL(file), 
          function(geometry) {
            // Calcular centro y dimensiones
            geometry.computeBoundingBox();
            const bbox = geometry.boundingBox;
            
            // Verificar que la geometría es válida
            if (!bbox || isNaN(bbox.min.x)) {
              throw new Error('Geometría del modelo no válida');
            }
            
            const center = new THREE.Vector3();
            bbox.getCenter(center);
            geometry.translate(-center.x, -center.y, -center.z);
            
            // Crear malla con material más visible
            const material = new THREE.MeshPhongMaterial({
              color: 0x00aaff,
              specular: 0x111111,
              shininess: 50,
              side: THREE.DoubleSide,
              transparent: true,
              opacity: 0.9
            });
            
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            
            // Ajustar cámara
            const maxDim = Math.max(
              bbox.max.x - bbox.min.x,
              bbox.max.y - bbox.min.y,
              bbox.max.z - bbox.min.z
            );
            camera.position.z = maxDim * 1.5;
            
            // Ocultar mensaje de carga
            loadingMessage.style.display = 'none';
            
            // Animación
            function animate() {
              animationId = requestAnimationFrame(animate);
              if (mesh) mesh.rotation.y += 0.01;
              renderer.render(scene, camera);
            }
            animate();
          },
          undefined, // No usar progreso
          function(error) {
            console.error('Error al cargar STL:', error);
            loadingMessage.textContent = 'Error al procesar el archivo STL';
            loadingMessage.style.display = 'block';
          }
        );
      } catch (error) {
        console.error('Error en el procesamiento:', error);
        loadingMessage.textContent = 'Error al mostrar el modelo';
        loadingMessage.style.display = 'block';
      }
    };
    
    reader.onerror = function(error) {
      console.error('Error de lectura:', error);
      loadingMessage.textContent = 'Error al leer el archivo';
      loadingMessage.style.display = 'block';
    };
    
    reader.onabort = function() {
      loadingMessage.textContent = 'Lectura del archivo cancelada';
      loadingMessage.style.display = 'block';
    };
    
    reader.readAsArrayBuffer(file);
  }

  // Evento para visor STL mejorado
  document.getElementById('stlFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      // Verificar tamaño del archivo (límite de 20MB)
      if (file.size > 20 * 1024 * 1024) {
        loadingMessage.textContent = 'Archivo demasiado grande (máx. 20MB)';
        loadingMessage.style.display = 'block';
        e.target.value = ''; // Limpiar selección
        return;
      }
      
      cargarSTL(file);
    } else {
      loadingMessage.textContent = 'Carga un archivo STL para ver el modelo aquí.';
      loadingMessage.style.display = 'block';
    }
  });
</script>
